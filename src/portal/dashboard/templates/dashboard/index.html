{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ symbol|default:"Arth-Insight" }} | Analytics Terminal</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=MV+Boli&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'dashboard/css/style.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* =========================================
           1. LOADER STYLES (With Your Signature)
           ========================================= */
        #loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.98);
            z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s ease;
        }
        .spinner-container { position: relative; width: 120px; height: 120px; display: flex; justify-content: center; align-items: center; }
        .loader-logo { width: 70px; height: 70px; border-radius: 50%; object-fit: contain; z-index: 2; }
        .loader-ring {
            position: absolute; width: 100%; height: 100%; border-radius: 50%;
            border: 5px solid transparent;
            border-top-color: #10b981; border-right-color: #3b82f6; border-bottom-color: #f59e0b; border-left-color: #ef4444;
            animation: spin 1.5s linear infinite; z-index: 1;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loader-text { margin-top: 25px; font-family: 'MV Boli', cursive; font-size: 0.9rem; color: #64748b; text-align: center; }
        .loader-text strong { display: block; font-size: 1.2rem; color: #0f172a; margin-bottom: 5px; font-family: 'Inter', sans-serif; }

        /* =========================================
           2. ATTRACTIVE LANDING PAGE STYLES
           ========================================= */
        .landing-wrapper {
            min-height: 100vh; display: flex; align-items: center; justify-content: center;
            background: radial-gradient(circle at center, #ffffff 0%, #f1f5f9 100%);
            text-align: center; padding: 20px;
        }
        .landing-content {
            max-width: 650px; width: 100%; padding: 50px 30px;
            background: white; border-radius: 30px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        /* Round Logo */
        .landing-logo-box {
            width: 100px; height: 100px; margin: 0 auto 25px;
            background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08); padding: 15px;
        }
        .landing-logo-img { width: 100%; height: 100%; object-fit: contain; }
        
        /* Split Color Text */
        .brand-title { font-size: 3.5rem; font-weight: 800; letter-spacing: -1.5px; margin-bottom: 10px; line-height: 1.1; }
        .text-blue-part { color: #2563eb; } 
        .text-green-part { color: #10b981; } 
        .text-dash { color: #94a3b8; font-weight: 300; }
        .brand-subtitle { font-size: 1.1rem; color: #64748b; margin-bottom: 40px; }
        
        /* Pill Search Bar */
        .search-container { position: relative; max-width: 500px; margin: 0 auto 30px; }
        .custom-search-input {
            width: 100%; padding: 18px 30px; padding-right: 120px;
            font-size: 1.1rem; border-radius: 100px; border: 2px solid #e2e8f0;
            background-color: #f8fafc; transition: all 0.3s ease; outline: none;
        }
        .custom-search-input:focus { border-color: #2563eb; background-color: #fff; box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1); }
        .analyze-btn-landing {
            position: absolute; right: 6px; top: 6px; bottom: 6px; padding: 0 25px;
            border-radius: 100px; border: none; background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white; font-weight: 600; font-size: 1rem; cursor: pointer; transition: transform 0.2s;
        }
        .analyze-btn-landing:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        .feature-pill { padding: 8px 16px; background: #f1f5f9; border-radius: 20px; font-size: 0.85rem; font-weight: 600; color: #475569; border: 1px solid #e2e8f0; margin: 0 5px; }

        /* =========================================
           3. DASHBOARD STYLES
           ========================================= */
        .price-summary-card { display: flex; justify-content: space-between; background: white; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid #e2e8f0; }
        .price-item { text-align: center; }
        .price-item span { display: block; font-size: 0.75rem; color: #64748b; text-transform: uppercase; font-weight: 600; }
        .price-item strong { display: block; font-size: 1.1rem; color: #0f172a; margin-top: 2px; }

        .finstar-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
        .finstar-card { background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-top: 4px solid #ccc; height: 100%; }
        .finstar-card h4 { font-size: 0.8rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 0.5rem; }
        .finstar-card .rating { font-size: 1.5rem; font-weight: 800; margin-bottom: 0.25rem; }
        .finstar-card .metric-row { font-size: 0.8rem; display: flex; justify-content: space-between; color: #64748b; }
        
        .essentials-container { background: white; padding: 1.5rem; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 1.5rem; }
        .section-title { font-size: 1rem; font-weight: 700; color: #334155; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 1rem; border-bottom: 2px solid #f1f5f9; padding-bottom: 0.5rem; }
        .essentials-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; row-gap: 1.5rem; }
        .essential-item label { display: block; font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: 700; margin-bottom: 2px; }
        .essential-item .val { font-size: 1rem; font-weight: 600; color: #0f172a; font-family: 'Roboto Mono', monospace; }
        
        /* Financial Tables */
        .finance-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .finance-table th { background: #f8fafc; padding: 10px; text-transform: uppercase; font-size: 0.75rem; color: #64748b; border-bottom: 2px solid #e2e8f0; position: sticky; top: 0; }
        .finance-table td { padding: 8px 10px; border-bottom: 1px solid #f1f5f9; color: #334155; }
        .finance-table tr:hover { background-color: #f8fafc; }
        
        .nav-pills .nav-link { color: #64748b; font-weight: 600; padding: 6px 16px; border-radius: 20px; }
        .nav-pills .nav-link.active { background-color: #0f172a; color: white; }
    </style>
</head>
<body>
    
    <div id="loader-overlay" style="display: none;">
        <div class="spinner-container">
            <div class="loader-ring"></div>
            <img src="{% static 'dashboard/images/logo.png' %}" class="loader-logo" alt="Loading...">
        </div>
        <div class="loader-text">
            <strong>Analyzing Market Data...</strong>
            Built by Narendra Bhandari
        </div>
    </div>

    {% if landing_mode %}
    
        <div class="landing-wrapper">
            <div class="landing-content">
                <div class="landing-logo-box">
                    <img src="{% static 'dashboard/images/logo.png' %}" alt="Logo" class="landing-logo-img">
                </div>

                <h1 class="brand-title">
                    <span class="text-blue-part">Arth</span><span class="text-dash">-</span><span class="text-green-part">Insight</span>
                </h1>
                
                <p class="brand-subtitle">Professional NSE Stock Analytics & AI Intelligence</p>

                <div class="search-container">
                    <form action="" method="GET" id="landingSearchForm">
                        <input type="text" name="q" class="custom-search-input" 
                               placeholder="Search Stock (e.g. SBIN, RELIANCE)..." 
                               autocomplete="off" required autofocus>
                        <button type="submit" class="analyze-btn-landing">Analyze</button>
                    </form>
                </div>

                <div class="feature-badges">
                    <span class="feature-pill">üáÆüá≥ NSE India</span>
                    <span class="feature-pill">‚ö° Real-Time</span>
                    <span class="feature-pill">ü§ñ AI Sentiment</span>
                </div>
            </div>
        </div>

    {% else %}
    
    <div class="container-fluid py-4">
        
        {% if error_message %}
        <div class="alert alert-danger text-center shadow-sm my-5 p-5">
            <h3 class="fw-bold text-danger">‚ö†Ô∏è Ticker Error</h3>
            <p class="fs-5">{{ error_message }}</p>
            <a href="/" class="btn btn-outline-danger mt-3">Try Another Symbol</a>
        </div>
        {% else %}

        <header class="header-container sticky-top mb-4 p-3 bg-dark text-white shadow d-flex justify-content-between align-items-center" style="z-index: 1020; border-radius: 0 0 10px 10px;">
            <div class="brand-section d-flex align-items-center">
                <img src="{% static 'dashboard/images/logo.png' %}" class="me-3 rounded bg-white p-1" alt="Logo" width="50" height="50">
                <div class="brand-text">
                    <h1 class="mb-0 fw-bold fs-4">{{ data.company_name|default:symbol }}</h1>
                    <div class="mt-1 d-flex align-items-center gap-2">
                        <span class="badge bg-warning text-dark">{{ data.sector|default:"Unknown Sector" }}</span>
                        <span class="badge bg-secondary">NSE: {{ symbol }}</span>
                        <small class="text-white-50 ms-2" style="font-size: 0.75rem;">Sync: {{ data.last_updated|date:"H:i" }} IST</small>
                    </div>
                </div>
            </div>
            <form class="d-flex gap-2 ms-auto" method="GET" id="searchForm" style="max-width: 400px;">
                <input type="text" name="q" value="{{ symbol }}" class="form-control" placeholder="Search another stock..." required>
                <button type="submit" class="btn btn-light fw-bold">Analyze</button>
            </form>
        </header>

        <div class="dashboard-container">
            {% if not data %}
             <div class="alert alert-danger">Error: No data loaded.</div>
            {% endif %}
        </div>

        {% if data.arth_score %}
        <div class="card mb-4 shadow-sm border-0" style="background: linear-gradient(to right, #f8fafc, #fff);">
            <div class="card-body d-flex align-items-center justify-content-between">
                <div>
                    <h5 class="text-uppercase text-muted fw-bold mb-1" style="font-size: 0.85rem; letter-spacing: 1px;">Arth-Insight Verdict</h5>
                    <h1 class="display-5 fw-bold mb-0 {{ data.arth_score.color }}">{{ data.arth_score.verdict }}</h1>
                </div>
                <div class="text-end">
                    <div class="d-inline-block position-relative">
                        <div style="width: 80px; height: 80px; border-radius: 50%; border: 6px solid {% if data.arth_score.score >= 60 %}#10b981{% elif data.arth_score.score < 40 %}#ef4444{% else %}#f59e0b{% endif %}; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: 800; color: #334155;">
                            {{ data.arth_score.score }}
                        </div>
                    </div>
                    <small class="d-block text-muted mt-1 fw-bold">/ 100</small>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="price-summary-card">
            <div class="price-item"><span>Price</span><strong>‚Çπ{{ data.price }}</strong></div>
            <div class="price-item"><span>High</span><strong class="text-success">‚Çπ{{ data.day_high|default:0 }}</strong></div>
            <div class="price-item"><span>Low</span><strong class="text-danger">‚Çπ{{ data.day_low|default:0 }}</strong></div>
            <div class="price-item"><span>52W High</span><strong>‚Çπ{{ data.52_high|default:0 }}</strong></div>
            <div class="price-item"><span>52W Low</span><strong>‚Çπ{{ data.52_low|default:0 }}</strong></div>
        </div>

        <div class="finstar-grid">
            <div class="finstar-card" style="border-top-color: {% if 'Stable' in narendra_rating.ownership.status or 'High' in narendra_rating.ownership.status %}#10b981{% else %}#ef4444{% endif %};">
                <h4>Ownership</h4>
                <div class="rating {{ narendra_rating.ownership.color }}">{{ narendra_rating.ownership.status }}</div>
                <div class="metric-row"><span class="metric-val">{{ narendra_rating.ownership.metric }}</span><span class="metric-bench">vs {{ narendra_rating.ownership.benchmark }}</span></div>
            </div>
            <div class="finstar-card" style="border-top-color: {% if 'Fair' in narendra_rating.valuation.status %}#3b82f6{% elif 'Expensive' in narendra_rating.valuation.status %}#ef4444{% else %}#10b981{% endif %};">
                <h4>Valuation</h4>
                <div class="rating {{ narendra_rating.valuation.color }}">{{ narendra_rating.valuation.status }}</div>
                <div class="metric-row"><span class="metric-val">{{ narendra_rating.valuation.metric }}</span><span class="metric-bench">vs {{ narendra_rating.valuation.benchmark }}</span></div>
            </div>
            <div class="finstar-card" style="border-top-color: {% if 'Excel' in narendra_rating.efficiency.status %}#10b981{% else %}#f59e0b{% endif %};">
                <h4>Efficiency</h4>
                <div class="rating {{ narendra_rating.efficiency.color }}">{{ narendra_rating.efficiency.status }}</div>
                <div class="metric-row"><span class="metric-val">{{ narendra_rating.efficiency.metric }}</span><span class="metric-bench">vs {{ narendra_rating.efficiency.benchmark }}</span></div>
            </div>
            <div class="finstar-card" style="border-top-color: {% if 'Solid' in narendra_rating.financials.status or 'Debt Free' in narendra_rating.financials.status %}#10b981{% else %}#ef4444{% endif %};">
                <h4>Financials</h4>
                <div class="rating {{ narendra_rating.financials.color }}">{{ narendra_rating.financials.status }}</div>
                <div class="metric-row"><span class="metric-val">{{ narendra_rating.financials.metric }}</span><span class="metric-bench">vs {{ narendra_rating.financials.benchmark }}</span></div>
            </div>
        </div>

        <div class="essentials-container mb-4" style="background: #f0fdf4; border: 1px solid #bbf7d0;">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                <h5 class="section-title text-success mb-0">üí∞ Wealth Growth Analysis</h5>
                <form class="d-flex gap-2" id="wealthForm">
                    <input type="hidden" name="q" value="{{ symbol }}">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text fw-bold">‚Çπ</span>
                        <input type="number" name="w_amt" value="{{ w_amt }}" class="form-control" style="width: 100px;">
                    </div>
                    <select name="w_year" class="form-select form-select-sm" style="width: auto;">
                        {% for y in year_range %}
                        <option value="{{ y }}" {% if y == w_year %}selected{% endif %}>{{ y }}</option>
                        {% endfor %}
                    </select>
                    <button class="btn btn-sm btn-success fw-bold">Calculate</button>
                </form>
            </div>
            
            {% if wealth_data %}
            <div class="row mt-3 align-items-center">
                <div class="col-md-4 border-end">
                    <div class="p-2">
                        <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Invested on {{ wealth_data.start_date }}</small>
                        <h3 class="mb-0 text-muted">‚Çπ{{ wealth_data.invested }}</h3>
                        <div class="text-start my-1 text-muted" style="font-size: 0.8rem;">‚¨á</div>
                        <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Current Value</small>
                        <h2 class="text-success fw-bold mb-0">‚Çπ{{ wealth_data.current_value }}</h2>
                        <span class="badge bg-success mt-2">+{{ wealth_data.growth_pct }}% Growth</span>
                        {% if wealth_data.is_adjusted %}
                        <div class="mt-2 text-warning small fw-bold">
                            ‚ö†Ô∏è Adjusted to IPO Year: {{ wealth_data.actual_start_year }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-8">
                    <div style="height: 200px; width: 100%;"><canvas id="wealthChart"></canvas></div>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="essentials-container mb-4">
            <h5 class="section-title">üì∞ Latest News & Market Updates</h5>
            <div class="list-group list-group-flush">
                {% if data.news %}
                    {% for n in data.news %}
                    <a href="{{ n.link }}" target="_blank" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold text-dark">{{ n.title|default:"Market Update" }}</div>
                            <small class="text-muted">{{ n.publisher|default:"News Source" }} ‚Ä¢ {{ n.date|default:"Recent" }}</small>
                        </div>
                        <span class="badge bg-light text-dark">Read</span>
                    </a>
                    {% endfor %}
                {% else %}
                    <div class="text-center p-3">
                        <p class="text-muted mb-2">No direct news feed available from API for {{ symbol }}.</p>
                        <a href="https://www.google.com/finance/quote/{{ symbol }}:NSE" target="_blank" class="btn btn-sm btn-outline-primary">
                            View on Google Finance ‚Üó
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>

        {% if data.policy %}
        <div class="essentials-container mb-4" style="background: #fffbeb; border: 1px solid #fcd34d;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="section-title text-warning mb-0" style="color: #b45309 !important;">
                    üèõÔ∏è Macro & Policy Context ({{ data.policy.sector_name }})
                </h5>
                <span class="badge bg-warning text-dark">Repo Rate: {{ data.policy.repo_rate }}</span>
            </div>
            
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="p-3 bg-white rounded border shadow-sm h-100">
                        <small class="text-uppercase fw-bold text-muted" style="font-size: 0.7rem;">
                            Union Budget {% if data.policy.dates.budget %}({{ data.policy.dates.budget }}){% endif %}
                        </small>
                        <p class="mb-0 mt-2 small fw-bold text-dark">{{ data.policy.insights.budget|default:"No specific mention." }}</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="p-3 bg-white rounded border shadow-sm h-100">
                        <small class="text-uppercase fw-bold text-muted" style="font-size: 0.7rem;">
                            RBI Policy {% if data.policy.dates.rbi %}({{ data.policy.dates.rbi }}){% endif %}
                        </small>
                        <p class="mb-0 mt-2 small fw-bold text-dark">{{ data.policy.insights.rbi|default:"No specific mention." }}</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="p-3 bg-white rounded border shadow-sm h-100">
                        <small class="text-uppercase fw-bold text-muted" style="font-size: 0.7rem;">
                            Eco Survey {% if data.policy.dates.eco_survey %}({{ data.policy.dates.eco_survey }}){% endif %}
                        </small>
                        <p class="mb-0 mt-2 small fw-bold text-dark">{{ data.policy.insights.eco_survey|default:"No specific mention." }}</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if data.technicals %}
        <div class="essentials-container mb-4">
            <h5 class="section-title">‚ö° Technical Signals & Trend</h5>
            <div class="row text-center g-3">
                <div class="col-md-4">
                    <div class="p-3 border rounded h-100 bg-light">
                        <small class="text-uppercase fw-bold text-muted">RSI (14-Day)</small>
                        <h3 class="my-2 {{ data.technicals.rsi.color }}">{{ data.technicals.rsi.val }}</h3>
                        <span class="badge bg-secondary">{{ data.technicals.rsi.status }}</span>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="p-3 border rounded h-100 bg-light">
                        <small class="text-uppercase fw-bold text-muted">Price Trend</small>
                        <h4 class="my-2 {{ data.technicals.trend.color }}">{{ data.technicals.trend.status }}</h4>
                        <small class="text-muted">{{ data.technicals.trend.desc }}</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="p-3 border rounded h-100 bg-light">
                        <small class="text-uppercase fw-bold text-muted">MACD Momentum</small>
                        <h3 class="my-2 {{ data.technicals.macd.color }}">{{ data.technicals.macd.val }}</h3>
                        <span class="badge bg-light text-dark border">{{ data.technicals.macd.status }}</span>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="essentials-container">
            <h5 class="section-title">üìã Company Essentials</h5>
            <div class="essentials-grid">
                <div class="essential-item"><label>Market Cap</label><span class="val">{{ data.mcap }}</span><span class="unit">Cr</span></div>
                <div class="essential-item"><label>Shares</label><span class="val">{{ data.shares_fmt }}</span></div>
                <div class="essential-item"><label>Ent. Value</label><span class="val">{{ data.enterprise_value }}</span><span class="unit">Cr</span></div>
                <div class="essential-item"><label>P/B Ratio</label><span class="val">{{ data.pb_ratio }}</span></div>
                <div class="essential-item"><label>Div Yield</label><span class="val text-success">{{ data.div_yield }}%</span></div>
                <div class="essential-item"><label>Cash</label><span class="val">{{ data.cash }}</span><span class="unit">Cr</span></div>
                <div class="essential-item"><label>Debt</label><span class="val text-danger">{{ data.debt }}</span><span class="unit">Cr</span></div>
                <div class="essential-item"><label>Promoter</label><span class="val">{{ data.promoter_holding }}%</span></div>
                <div class="essential-item"><label>ROE</label><span class="val">{{ data.roe }}%</span></div>
                <div class="essential-item"><label>Profit Gr.</label><span class="val {% if data.profit_growth > 0 %}text-success{% else %}text-danger{% endif %}">{{ data.profit_growth }}%</span></div>
            </div>
        </div>

        <div class="essentials-container mb-4">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                    <h5 class="section-title mb-1">PERFORMANCE vs {{ bench_stats.symbol }}</h5>
                    <div class="d-flex gap-3 small text-muted">
                        <span>Stock Return: <strong class="{% if bench_stats.stock_return_pct > 0 %}text-success{% else %}text-danger{% endif %}">{{ bench_stats.stock_return_pct }}%</strong></span>
                        <span>{{ bench_stats.symbol }} Return: <strong>{{ bench_stats.return_pct }}%</strong></span>
                        <span>CAGR (5Y): <strong class="text-success">{{ data.cagr_5y }}%</strong></span>
                    </div>
                </div>
                <div class="btn-group" id="filterBtns">
                    <button class="btn btn-sm btn-outline-secondary" onclick="updateChart('1m', this)">1M</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="updateChart('6m', this)">6M</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="updateChart('1y', this)">1Y</button>
                    <button class="btn btn-sm btn-outline-primary active" onclick="updateChart('all', this)">5Y</button>
                </div>
            </div>
            <div style="height: 350px; width: 100%;"><canvas id="mainChart"></canvas></div>
            <div style="height: 100px; width: 100%; margin-top: 10px;"><canvas id="volumeChart"></canvas></div>
        </div>

        <div class="essentials-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="section-title mb-0">‚öñÔ∏è Sector Peers & Market Share ({{ data.sector }})</h5>
                <small class="text-muted" style="font-size: 0.75rem;">Key: <span class="text-success">‚ñ≤ Expensive</span> | <span class="text-danger">‚ñº Cheap</span></small>
            </div>
            <div class="table-responsive">
                <table class="peer-table table">
                    <thead><tr><th>Company</th><th>Price</th><th>M.Cap (Cr)</th><th>Share %</th><th>P/E</th><th>ROE</th><th>Status</th></tr></thead>
                    <tbody>
                        <tr class="current-stock-row table-success"><td><strong class="text-success">{{ symbol }}</strong></td><td>{{ data.price }}</td><td>{{ data.mcap }}</td><td><span class="badge bg-success">{{ my_share }}%</span></td><td>{{ data.pe_ratio }}</td><td>{{ data.roe }}%</td><td>--</td></tr>
                        {% for p in peers %}
                        <tr><td>{{ p.ticker }}</td><td>{{ p.price }}</td><td>{{ p.mcap }}</td><td><span class="badge bg-light text-dark">{{ p.share }}%</span></td><td>{{ p.pe }}</td><td>{{ p.roe }}%</td><td>{% if p.pe > data.pe_ratio %}<span class="text-danger">‚ñ≤ Exp</span>{% else %}<span class="text-success">‚ñº Cheap</span>{% endif %}</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0 fw-bold">üì¢ Shareholding Pattern</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 text-center">
                        <canvas id="shareholdingChart" style="max-height: 250px;"></canvas>
                        <p id="no-share-data" class="text-muted mt-3" style="display: none;">No shareholding data available for this stock.</p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted text-uppercase small fw-bold mb-3">Top Investors / Institutions</h6>
                        {% if shareholding.top_investors %}
                            <ul class="list-group list-group-flush">
                                {% for investor in shareholding.top_investors %}
                                <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <span class="text-dark small">{{ investor.name }}</span>
                                    <span class="badge bg-light text-dark border">{{ investor.stake }}%</span>
                                </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <div class="alert alert-light border text-center p-3">
                                <small class="text-muted">
                                    <i class="bi bi-shield-lock"></i> Detailed investor names are currently unavailable from the data source.<br>(Total Institutional Holding: {{ shareholding.institution }}%)
                                </small>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        {% if financials %}
        <div class="essentials-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="section-title mb-0">üìë Financial Statements (‚Çπ Crores)</h5>
                <ul class="nav nav-pills nav-sm" id="finTabs" role="tablist">
                    <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pl">Income Statement</button></li>
                    <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#bs">Balance Sheet</button></li>
                    <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#cf">Cash Flow</button></li>
                    <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#re">Retained Earnings</button></li>
                </ul>
            </div>
            
            <div class="tab-content" id="pills-tabContent">
                <div class="tab-pane fade show active" id="pl">
                    <table class="finance-table">
                        <thead><tr><th>Account Title</th>{% for y in financials.years %}<th class="text-end">{{ y }}</th>{% endfor %}</tr></thead>
                        <tbody>{% for row in financials.pl_rows %}<tr style="{{ row.style }}"><td>{{ row.label }}</td>{% for val in row.values %}<td class="text-end">{{ val }}</td>{% endfor %}</tr>{% endfor %}</tbody>
                    </table>
                </div>
                <div class="tab-pane fade" id="bs">
                    <table class="finance-table">
                        <thead><tr><th>Account Title</th>{% for y in financials.years %}<th class="text-end">{{ y }}</th>{% endfor %}</tr></thead>
                        <tbody>{% for row in financials.bs_rows %}<tr style="{{ row.style }}"><td>{{ row.label }}</td>{% for val in row.values %}<td class="text-end">{{ val }}</td>{% endfor %}</tr>{% endfor %}</tbody>
                    </table>
                </div>
                <div class="tab-pane fade" id="cf">
                    <table class="finance-table">
                        <thead><tr><th>Account Title</th>{% for y in financials.years %}<th class="text-end">{{ y }}</th>{% endfor %}</tr></thead>
                        <tbody>{% for row in financials.cf_rows %}<tr style="{{ row.style }}"><td>{{ row.label }}</td>{% for val in row.values %}<td class="text-end">{{ val }}</td>{% endfor %}</tr>{% endfor %}</tbody>
                    </table>
                </div>
                <div class="tab-pane fade" id="re">
                    <table class="finance-table">
                        <thead><tr><th>Account Title</th><th class="text-end">Amount</th></tr></thead>
                        <tbody>{% for row in financials.re_rows %}<tr style="{{ row.style }}"><td>{{ row.label }}</td><td class="text-end">{{ row.values.0 }}</td></tr>{% endfor %}</tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        {% endif %}
        
        <footer class="text-center bg-primary py-4 text-muted small" style="font-family: 'MV Boli', cursive;">Built by Narendra Bhandari @ 2026</footer>
    </div>
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const loader = document.getElementById('loader-overlay');
        // 1. UNIVERSAL LOADER FOR ALL FORMS (Fixes Wealth Calculation)
        document.querySelectorAll('form').forEach(form => {
            form.addEventListener('submit', function() {
                if(loader) {
                    loader.style.display = 'flex';
                    loader.style.opacity = '1';
                }
            });
        });
        window.addEventListener('load', function() {
            setTimeout(() => { if(loader) { loader.style.opacity = '0'; setTimeout(() => { loader.style.display = 'none'; }, 500); } }, 600); 
        });
        {% if not landing_mode and not error_message %}
        const rawDates = {{ chart_dates|safe }};
        const stockData = {{ chart_stock_pct|safe }};
        const benchData = {{ chart_bench_pct|safe }};
        const volumeData = {{ chart_volumes|safe }};
        {% if wealth_data %}
        new Chart(document.getElementById('wealthChart'), {
            type: 'line',
            data: {
                labels: {{ wealth_dates|safe }},
                datasets: [{
                    label: 'Portfolio Value (‚Çπ)', data: {{ wealth_series|safe }},
                    borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    fill: true, pointRadius: 0, borderWidth: 2
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } }
        });
        {% endif %}

        const ctxPrice = document.getElementById('mainChart').getContext('2d');
        const priceChart = new Chart(ctxPrice, {
            type: 'line',
            data: {
                labels: rawDates,
                datasets: [
                    { label: '{{ symbol }} (%)', data: stockData, borderColor: '#10b981', borderWidth: 2, pointRadius: 0, fill: true, backgroundColor: 'rgba(16, 185, 129, 0.05)', tension: 0.1 },
                    { label: '{{ bench_stats.symbol }} (%)', data: benchData, borderColor: '#64748b', borderWidth: 2, pointRadius: 0, borderDash: [4, 4], fill: false, tension: 0.1 }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { position: 'top', labels: { usePointStyle: true } } }, scales: { x: { display: false }, y: { position: 'right', grid: { color: '#f1f5f9' }, ticks: { callback: v => v + '%' } } } }
        });
        const volumeChart = new Chart(document.getElementById('volumeChart'), {
            type: 'bar',
            data: { labels: rawDates, datasets: [{ label: 'Vol', data: volumeData, backgroundColor: '#3b82f6', borderRadius: 1 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: true, ticks: { maxTicksLimit: 6 } }, y: { display: false } } }
        });
        document.addEventListener("DOMContentLoaded", function() {
            var pieLabels = {{ pie_labels|default:"[]"|safe }};
            var pieData = {{ pie_data|default:"[]"|safe }};
            var total = 0;
            if (Array.isArray(pieData) && pieData.length > 0) { total = pieData.reduce((a, b) => a + b, 0); }
            var ctx = document.getElementById('shareholdingChart');
            var msg = document.getElementById('no-share-data');

            if (ctx && total > 0) {
                if(msg) msg.style.display = 'none';
                ctx.style.display = 'block';
                new Chart(ctx, {
                    type: 'doughnut',
                    data: { labels: pieLabels, datasets: [{ data: pieData, backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc'], hoverBackgroundColor: ['#2e59d9', '#17a673', '#2c9faf'], hoverBorderColor: "rgba(234, 236, 244, 1)" }] },
                    options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }, tooltip: { callbacks: { label: function(context) { return context.label + ': ' + context.parsed + '%'; } } } }, cutout: '70%' }
                });
            } else {
                if(ctx) ctx.style.display = 'none';
                if(msg) msg.style.display = 'block';
            }
        });
        function updateChart(period, btn) {
            document.querySelectorAll('#filterBtns .btn').forEach(b => { b.classList.remove('active', 'btn-outline-primary'); b.classList.add('btn-outline-secondary'); });
            btn.classList.add('active', 'btn-outline-primary'); btn.classList.remove('btn-outline-secondary');
            let limit = rawDates.length;
            if (period === '7d') limit = 7;
            if (period === '1m') limit = 22; if (period === '6m') limit = 130;
            if (period === '1y') limit = 252;
            const subDates = rawDates.slice(-limit); const subStock = stockData.slice(-limit); const subBench = benchData.slice(-limit);
            const subVol = volumeData.slice(-limit);
            const startS = subStock[0]; const startB = subBench[0];
            priceChart.data.labels = subDates;
            priceChart.data.datasets[0].data = subStock.map(v => (v - startS).toFixed(2));
            priceChart.data.datasets[1].data = subBench.map(v => (v - startB).toFixed(2));
            priceChart.update();
            volumeChart.data.labels = subDates;
            volumeChart.data.datasets[0].data = subVol; volumeChart.update();
        }
        {% endif %}
    </script>
</body>
</html>