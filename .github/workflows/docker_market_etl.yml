name: Docker Market Data ETL

on:
  schedule:
    # Runs every hour from 03:30 UTC to 10:30 UTC (9:00 AM - 4:00 PM IST)
    - cron: '30 3-10 * * 1-5'
  
  workflow_dispatch: # Allows manual trigger

jobs:
  run-etl-container:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # 1. Build the Docker Image locally in the Runner
      - name: Build ETL Image
        run: |
          docker build -t market-etl-image .

      # 2. Run the ETL Script inside the Container
      # We pass all secrets and the service account as environment variables
      - name: Run Market Feed
        env:
          GCP_DATASET_ID: ${{ secrets.GCP_DATASET_ID }}
          GCP_SERVICE_JSON: ${{ secrets.GCP_SERVICE_JSON }}
          DJANGO_SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY }}
        run: |
          # Create the service account file inside the runner to mount it
          echo "$GCP_SERVICE_JSON" > service-account.json
          
          docker run \
            -v $(pwd)/service-account.json:/app/service-account.json \
            -e GOOGLE_APPLICATION_CREDENTIALS=/app/service-account.json \
            -e GCP_DATASET_ID=$GCP_DATASET_ID \
            -e DJANGO_SECRET_KEY=$DJANGO_SECRET_KEY \
            market-etl-image \
            python scripts/market_feed.py force